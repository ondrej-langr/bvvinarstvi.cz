import{r as u,e as O,Q as G,z as Q,_ as W,b as K,j as r,p as B,$ as H,a0 as J,a1 as X,a2 as Y,a3 as L,a4 as U,a5 as Z,a6 as E,h as d,F as ee,a7 as se,m as y,a8 as D,a9 as C,k as x,aa as M,A as te,T as ae,ab as N,ac as re,ad as h,ae as V,af as v,a as S,x as R,v as ne,ag as T,ah as oe,ai as ie,aj as ce,ak as le,al as de}from"./index.339d4384.js";var ue=Object.defineProperty,I=Object.getOwnPropertySymbols,pe=Object.prototype.hasOwnProperty,me=Object.prototype.propertyIsEnumerable,A=(t,e,s)=>e in t?ue(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,F=(t,e)=>{for(var s in e||(e={}))pe.call(e,s)&&A(t,s,e[s]);if(I)for(var s of I(e))me.call(e,s)&&A(t,s,e[s]);return t};function ge(t){const[e,s]=u.exports.useState(t),o=u.exports.useCallback(i=>s(n=>F(F({},n),typeof i=="function"?i(n):i)),[]);return[e,o]}const _=u.exports.createContext({view:"create",isLoading:!0,exitView:()=>{},mutateUser:async()=>{}}),g=()=>u.exports.useContext(_),fe=({view:t,children:e})=>{const s=O(),{userId:o}=G(),i=Q("users"),n=W(o,{enabled:!1}),c=K(),l=()=>s(B.users.list),p=u.exports.useCallback(m=>{c.setQueryData(n.key,a=>({...a,...m}))},[c,n.key]);return u.exports.useEffect(()=>(o&&n.refetch(),()=>n.remove()),[o]),r(_.Provider,{value:{view:t,...n.data?{user:n.data}:{},mutateUser:p,isLoading:n.isLoading||n.isError,exitView:l,model:i},children:e})};function we(t){var e=t==null?0:t.length;return e?t[e-1]:void 0}var be=we,he=H,xe=J;function Se(t,e){return e.length<2?t:he(t,xe(e,0,-1))}var ke=Se,ve=X,Ue=be,ye=ke,Ne=Y;function Ce(t,e){return e=ve(e,t),t=ye(t,e),t==null||delete t[Ne(Ue(e))]}var _e=Ce,Pe=_e;function Ee(t,e){return t==null?!0:Pe(t,e)}var Me=Ee;const Re=()=>{const{model:t}=g(),e=L(),{formState:s}=U(),o=u.exports.useMemo(()=>{if(!t)return;const i={...t,columns:new Map(t.columns)};return i.columns.has("role")&&!(e!=null&&e.can({action:"update",targetModel:"users"}))&&Me(i,"columns.role"),Z(i,E.MAIN)},[t,e]);return d(ee,{children:[o&&r(se,{type:E.MAIN,fields:o}),s.isSubmitting&&r("div",{className:"absolute inset-0 cursor-progress bg-white/20 backdrop-blur-[2px]"})]})},Te=()=>{const{view:t}=g(),{t:e}=y();return r("header",{className:"mr-9 w-full border-b-2 border-project-border pb-5 xl:mr-0",children:r("h1",{className:"m-0 text-5xl font-bold",children:e(t=="update"?"Update an user":"Create an user")})})},Ie=()=>({aside:"xl:max-w-md w-full xl:mx-9 xl:mt-0 mt-5"}),Ae=({className:t,...e})=>r(V,{className:x("relative top-0.5 inline-block h-4",t),...e}),Fe=()=>{const{isLoading:t,view:e,user:s,exitView:o,mutateUser:i}=g(),{watch:n,formState:{isSubmitting:c}}=U(),l=L(),p=n(),m=Ie(),{t:a}=y(),f=D(),[P,k]=ge({isSendingPasswordReset:!1,isTogglingBlock:!1}),j=u.exports.useMemo(()=>e==="update"?!!Object.keys(C(s||{},p)).length:!0,[p,e,s]),q=async()=>{confirm(a(v.ON_DELETE_REQUEST_PROMPT))&&(o(),S.users.delete(s==null?void 0:s.id))},$=async()=>{k({isSendingPasswordReset:!0});const w=(s==null?void 0:s.state)===h.passwordReset;try{await f({title:a("Password reset"),message:a(w?"Resending password reset email":"Sending user password reset email"),successMessage:a("User can now follow instruction in their email")},async()=>{const{data:b}=await S.users.requestPasswordReset(s.email);i(b.data)})}catch{}k({isSendingPasswordReset:!1})},z=async()=>{k({isTogglingBlock:!0});const w=s.state===h.blocked;try{await f({title:a(w?"Unblocking":"Blocking"),message:"",successMessage:a(w?"User is now unblocked":"User is now blocked")},async()=>{const{data:b}=await S.users[w?"unblock":"block"](s.id);i(b.data)})}catch{}k({isTogglingBlock:!1})};return d("aside",{className:x(m.aside,"sticky top-0 grid gap-5"),children:[d(M,{className:"!pt-0",title:"Apply changes",children:[e==="update"&&r("div",{className:x("w-full bg-white py-5 px-4"),children:r("ul",{className:"flex list-disc flex-col gap-2 pl-5",children:d("li",{children:[a("State"),":"," ",t?r(Ae,{className:"w-full max-w-[6rem]"}):r("span",{className:"font-semibold text-blue-600",children:s==null?void 0:s.state})]})})}),d("div",{className:"flex items-center justify-between gap-5 border-t-2 border-project-border px-4 py-4",children:[e==="update"?r(te,{size:"lg",type:"button",loading:c,onClick:q,color:"red",variant:"light",className:x(c&&"!cursor-progress","text-sm text-red-500"),children:r(ae,{className:"aspect-square w-5"})}):r("span",{}),r(N,{size:"lg",color:"green",type:"submit",disabled:c||!j,loading:c,className:x(c&&"!cursor-progress"),children:a(c?e==="create"?"Creating...":"Updating...":e==="create"?"Create":"Update")})]})]}),e==="update"&&(l==null?void 0:l.can({action:"update",targetModel:"users"}))&&r(M,{title:a("Actions"),children:d(re,{cols:1,className:"p-5",children:[r(N,{loading:P.isSendingPasswordReset,disabled:!s||(s==null?void 0:s.state)===h.blocked,onClick:$,children:a((s==null?void 0:s.state)===h.passwordReset?"Resend password reset":"Send password reset")}),r(N,{loading:P.isTogglingBlock,disabled:!s,color:"red",onClick:z,children:a((s==null?void 0:s.state)===h.blocked?"Unblock user":"Block user")})]})})]})},Oe=()=>{const t=O(),e=D(),{view:s,user:o,mutateUser:i}=g(),{t:n}=y(),{setError:c}=U();return async p=>{var m;try{await e({title:s==="update"?"Updating":"Creating",message:n(s==="update"?"Updating user data, please wait":"Creating new user, please wait"),successMessage:n(s==="update"?"User data has been updated!":"New user has been created!"),errorMessage:a=>{var f;return R.isAxiosError(a)&&((f=a.response)==null?void 0:f.status)===409?n(v.DUPLICATE_USER):n(v.ERROR_BASIC)}},async()=>{if(s==="update"){const a=await S.users.update(o==null?void 0:o.id,C(o,p));i(a.data.data)}else if(s==="create"){const a=await S.users.create(C(o||{},p));a!=null&&a.data&&t(B.users.list)}})}catch(a){R.isAxiosError(a)&&((m=a.response)==null?void 0:m.status)===409&&c("email",{message:n(v.DUPLICATE_USER)})}}},Be=({children:t})=>{const{handleSubmit:e}=U(),s=Oe();return r("form",{onSubmit:e(s),autoComplete:"off",children:t})},Le=()=>{var l;const{user:t,model:e,isLoading:s,view:o}=g(),{t:i}=y(),n=ne({defaultValues:t||{},reValidateMode:"onBlur",mode:"onTouched",resolver:o==="create"?T(oe):T(ie)}),{reset:c}=n;return u.exports.useEffect(()=>{t&&c(t)},[t,c]),r(ce,{...n,children:d(Be,{children:[r(le,{className:"py-5",items:[{content:de((e==null?void 0:e.tableName)||""),isLinkTo:`/${(l=e==null?void 0:e.tableName)==null?void 0:l.toLowerCase()}`},{content:i(o=="update"?"Update":"Create")},...o==="update"?[{content:s?r(V,{className:"h-4 w-16"}):r("p",{className:"text-green-500 underline",children:o=="update"?t==null?void 0:t.id:"Send invite"})}]:[]]}),d("div",{className:"mt-10 items-start justify-between xl:flex",children:[d("div",{className:"relative -mx-3 grid w-full max-w-4xl gap-5 px-3",children:[r(Te,{}),r(Re,{})]}),r(Fe,{})]})]})})},Ve={Context:_,ContextProvider:fe,useData:g,Content:Le};export{Ve as U};
