import{r as p,e as I,Q as $,z,_ as G,b as Q,j as a,p as O,$ as K,a0 as H,a1 as J,a2 as X,a3 as F,a4 as U,a5 as Y,a6 as _,h as u,F as Z,a7 as ee,m as y,a8 as B,a9 as N,aa as se,ab as P,k,A as te,T as ae,ac as C,ad as re,ae as b,af as L,ag as v,a as h,x as E,v as ne,ah as oe,ai as ie,aj as ce,ak as M,al as le,am as de}from"./index.d96b26d5.js";var ue=Object.defineProperty,R=Object.getOwnPropertySymbols,pe=Object.prototype.hasOwnProperty,me=Object.prototype.propertyIsEnumerable,T=(t,e,s)=>e in t?ue(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,A=(t,e)=>{for(var s in e||(e={}))pe.call(e,s)&&T(t,s,e[s]);if(R)for(var s of R(e))me.call(e,s)&&T(t,s,e[s]);return t};function ge(t){const[e,s]=p.exports.useState(t),n=p.exports.useCallback(o=>s(r=>A(A({},r),typeof o=="function"?o(r):o)),[]);return[e,n]}const D=p.exports.createContext({view:"create",isLoading:!0,exitView:()=>{},mutateUser:async()=>{}}),x=()=>p.exports.useContext(D),Be=({view:t,children:e})=>{const s=I(),{userId:n}=$(),o=z("users"),r=G(n,{enabled:!1}),l=Q(),d=()=>s(O.users.list),m=p.exports.useCallback(i=>{l.setQueryData(r.key,c=>({...c,...i}))},[l,r.key]);return p.exports.useEffect(()=>(n&&r.refetch(),()=>r.remove()),[n]),a(D.Provider,{value:{view:t,...r.data?{user:r.data}:{},mutateUser:m,isLoading:r.isLoading||r.isError,exitView:d,model:o},children:e})};function fe(t){var e=t==null?0:t.length;return e?t[e-1]:void 0}var we=fe,be=K,he=H;function xe(t,e){return e.length<2?t:be(t,he(e,0,-1))}var Se=xe,ke=J,ve=we,Ue=Se,ye=X;function Ce(t,e){return e=ke(e,t),t=Ue(t,e),t==null||delete t[ye(ve(e))]}var Ne=Ce,_e=Ne;function Pe(t,e){return t==null?!0:_e(t,e)}var Ee=Pe;const Me=()=>{const{model:t}=x(),e=F(),{formState:s}=U(),n=p.exports.useMemo(()=>{if(!t)return;const o={...t,columns:new Map(t.columns)};return o.columns.has("role")&&!(e!=null&&e.can({action:"update",targetModel:"users"}))&&Ee(o,"columns.role"),Y(o,_.MAIN)},[t,e]);return u(Z,{children:[n&&a(ee,{type:_.MAIN,fields:n}),s.isSubmitting&&a("div",{className:"absolute inset-0 cursor-progress bg-white/20 backdrop-blur-[2px]"})]})},Re=()=>{const{view:t}=x(),{t:e}=y();return a("header",{className:"mr-9 w-full border-b-2 border-project-border pb-5 xl:mr-0",children:a("h1",{className:"m-0 text-5xl font-bold",children:e(t=="update"?"Update an user":"Create an user")})})},Te=({className:t,...e})=>a(L,{className:k("relative top-0.5 inline-block h-4",t),...e}),Ae=()=>{const{isLoading:t,view:e,user:s,exitView:n,mutateUser:o}=x(),{watch:r,formState:{isSubmitting:l}}=U(),d=F(),m=r(),{t:i}=y(),c=B(),[g,S]=ge({isSendingPasswordReset:!1,isTogglingBlock:!1}),V=p.exports.useMemo(()=>e==="update"?!!Object.keys(N(s||{},m)).length:!0,[m,e,s]),j=async()=>{confirm(i(v.ON_DELETE_REQUEST_PROMPT))&&(n(),h.users.delete(s==null?void 0:s.id))},q=async()=>{S({isSendingPasswordReset:!0});const f=(s==null?void 0:s.state)===b.passwordReset;try{await c({title:i("Password reset"),message:i(f?"Resending password reset email":"Sending user password reset email"),successMessage:i("User can now follow instruction in their email")},async()=>{const{data:w}=await h.users.requestPasswordReset(s.email);o(w.data)})}catch{}S({isSendingPasswordReset:!1})},W=async()=>{S({isTogglingBlock:!0});const f=s.state===b.blocked;try{await c({title:i(f?"Unblocking":"Blocking"),message:"",successMessage:i(f?"User is now unblocked":"User is now blocked")},async()=>{const{data:w}=await h.users[f?"unblock":"block"](s.id);o(w.data)})}catch{}S({isTogglingBlock:!1})};return u(se,{isOpen:!0,children:[u(P,{className:"!pt-0",title:"Apply changes",children:[e==="update"&&a("div",{className:k("w-full bg-white py-5 px-4"),children:a("ul",{className:"flex list-disc flex-col gap-2 pl-5",children:u("li",{children:[i("State"),":"," ",t?a(Te,{className:"w-full max-w-[6rem]"}):a("span",{className:"font-semibold text-blue-600",children:s==null?void 0:s.state})]})})}),u("div",{className:"flex items-center justify-between gap-5 border-t-2 border-project-border px-4 py-4",children:[e==="update"?a(te,{size:"lg",type:"button",loading:l,onClick:j,color:"red",variant:"light",className:k(l&&"!cursor-progress","text-sm text-red-500"),children:a(ae,{className:"aspect-square w-5"})}):a("span",{}),a(C,{size:"lg",color:"green",type:"submit",disabled:l||!V,loading:l,className:k(l&&"!cursor-progress"),children:i(l?e==="create"?"Creating...":"Updating...":e==="create"?"Create":"Update")})]})]}),e==="update"&&(d==null?void 0:d.can({action:"update",targetModel:"users"}))&&a(P,{title:i("Actions"),children:u(re,{cols:1,className:"p-5",children:[a(C,{loading:g.isSendingPasswordReset,disabled:!s||(s==null?void 0:s.state)===b.blocked,onClick:q,children:i((s==null?void 0:s.state)===b.passwordReset?"Resend password reset":"Send password reset")}),a(C,{loading:g.isTogglingBlock,disabled:!s,color:"red",onClick:W,children:i((s==null?void 0:s.state)===b.blocked?"Unblock user":"Block user")})]})})]})},Ie=()=>{const t=I(),e=B(),{view:s,user:n,mutateUser:o}=x(),{t:r}=y(),{setError:l}=U();return async m=>{var i;try{await e({title:s==="update"?"Updating":"Creating",message:r(s==="update"?"Updating user data, please wait":"Creating new user, please wait"),successMessage:r(s==="update"?"User data has been updated!":"New user has been created!"),errorMessage:c=>{var g;return E.isAxiosError(c)&&((g=c.response)==null?void 0:g.status)===409?r(v.DUPLICATE_USER):r(v.ERROR_BASIC)}},async()=>{if(s==="update"){const c=await h.users.update(n==null?void 0:n.id,N(n,m));o(c.data.data)}else if(s==="create"){const c=await h.users.create(N(n||{},m));c!=null&&c.data&&t(O.users.list)}})}catch(c){E.isAxiosError(c)&&((i=c.response)==null?void 0:i.status)===409&&l("email",{message:r(v.DUPLICATE_USER)})}}},Oe=({children:t})=>{const{handleSubmit:e}=U(),s=Ie();return a("form",{onSubmit:e(s),autoComplete:"off",children:t})},Le=()=>{var d;const{user:t,model:e,isLoading:s,view:n}=x(),{t:o}=y(),r=ne({defaultValues:t||{},reValidateMode:"onBlur",mode:"onTouched",resolver:n==="create"?M(le):M(de)}),{reset:l}=r;return p.exports.useEffect(()=>{t&&l(t)},[t,l]),a(oe,{...r,children:u(Oe,{children:[a(ie,{className:"py-5",items:[{content:ce((e==null?void 0:e.tableName)||""),isLinkTo:`/${(d=e==null?void 0:e.tableName)==null?void 0:d.toLowerCase()}`},{content:o(n=="update"?"Update":"Create")},...n==="update"?[{content:s?a(L,{className:"h-4 w-16"}):a("p",{className:"text-green-500 underline",children:n=="update"?t==null?void 0:t.id:"Send invite"})}]:[]]}),u("div",{className:"mt-10 items-start justify-between xl:flex",children:[u("div",{className:"relative -mx-3 grid w-full max-w-4xl gap-5 px-3",children:[a(Re,{}),a(Me,{})]}),a(Ae,{})]})]})})};export{Be as C,Le as a};
